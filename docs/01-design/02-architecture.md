# 系统架构设计

## 1. 架构概述

MovieInfo项目采用**服务化架构**，将整个系统划分为四个独立的服务。这种设计旨在实现关注点分离，提高系统的可维护性、可扩展性和可测试性。虽然目前所有服务都部署在同一个代码仓库中，但这种架构为未来平滑过渡到分布式微服务架构奠定了坚实的基础。

### 1.1 设计原则

- **单一职责原则 (SRP)**：每个服务都聚焦于一个特定的业务领域（用户、电影、评论），使其职责清晰。
- **高内聚，低耦合**：服务内部的功能紧密相关，而服务之间的依赖则通过明确定义的API（gRPC）进行，降低耦合度。
- **可扩展性**：每个服务都可以独立扩展，以应对不同业务负载的增长。
- **技术异构性**：未来可以针对不同服务的特点，采用最合适的技术栈进行重构或优化，而不会影响其他服务。

### 1.2 整体架构图

```mermaid
graph TD
    subgraph "用户端 (Client)"
        A[用户浏览器] --> B{主页服务 (Web Gateway)};
    end

    subgraph "后端服务 (Backend Services)"
        B --> C[用户服务 (User Service)];
        B --> D[电影服务 (Movie Service)];
        B --> E[评论服务 (Comment Service)];
    end

    subgraph "数据存储 (Data Persistence)"
        C --> F[(MySQL)];
        D --> F;
        E --> F;
        C --> G[(Redis)];
        D --> G;
    end

    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#ccf,stroke:#333,stroke-width:2px
    style D fill:#ccf,stroke:#333,stroke-width:2px
    style E fill:#ccf,stroke:#333,stroke-width:2px
    style F fill:#cff,stroke:#333,stroke-width:2px
    style G fill:#cff,stroke:#333,stroke-width:2px
```

## 2. 服务划分

系统被划分为以下四个核心服务：

### 2.1 主页服务 (Web Gateway)

- **角色**：系统的统一入口，扮演API网关的角色。
- **职责**：
    - 接收所有来自客户端的HTTP请求。
    - 渲染前端页面（使用Gin Template）。
    - 作为gRPC客户端，调用后端业务服务（用户、电影、评论）的接口。
    - 聚合来自不同服务的数据，并返回给客户端。
    - 处理用户会话管理和部分中间件逻辑（如日志、认证）。
- **技术栈**：`Gin`, `Gin Template`, `gRPC Client`。

### 2.2 用户服务 (User Service)

- **角色**：负责所有与用户相关的业务逻辑。
- **职责**：
    - 用户注册、登录、密码管理。
    - 用户个人资料的CRUD操作。
    - JWT Token的生成与验证。
    - 权限管理（RBAC）。
- **技术栈**：`Gin`, `gRPC Server`, `GORM`, `MySQL`。

### 2.3 电影服务 (Movie Service)

- **角色**：负责所有与电影信息相关的业务逻辑。
- **职责**：
    - 电影信息的CRUD操作。
    - 电影分类、标签的管理。
    - 实现复杂的电影搜索和筛选功能。
    - 管理电影数据的缓存（使用Redis）。
- **技术栈**：`Gin`, `gRPC Server`, `GORM`, `MySQL`, `Redis`。

### 2.4 评论服务 (Comment Service)

- **角色**：负责所有与电影评论和评分相关的业务逻辑。
- **职责**：
    - 用户发表、修改、删除评论。
    - 用户对电影进行评分。
    - 评论的点赞和回复功能。
    - 评分数据的统计与计算。
- **技术栈**：`Gin`, `gRPC Server`, `GORM`, `MySQL`。

## 3. 通信协议

### 3.1 外部通信 (Client <-> Gateway)

- **协议**：`HTTP/1.1`
- **数据格式**：`JSON`
- **说明**：客户端（浏览器）通过标准的HTTP协议与主页服务（网关）进行通信。所有API都遵循RESTful风格。

### 3.2 内部通信 (Gateway <-> Backend Services)

- **协议**：`gRPC`
- **数据格式**：`Protocol Buffers (Protobuf)`
- **说明**：服务之间的内部调用采用gRPC。选择gRPC的原因如下：
    - **高性能**：基于HTTP/2，支持多路复用、头部压缩，通信效率高。
    - **强类型**：使用Protobuf定义服务接口，提供了严格的类型检查，减少运行时错误。
    - **跨语言**：支持多种编程语言，为未来的技术异构性提供了可能。
    - **代码生成**：自动生成客户端和服务端代码，简化了开发流程。

## 4. 数据存储

### 4.1 关系型数据库 (MySQL)

- **作用**：作为项目的主数据库，存储所有持久化数据，如用户信息、电影数据、评论等。
- **版本**：MySQL 8.0。
- **ORM框架**：使用`GORM`来简化数据库操作，提高开发效率。

### 4.2 缓存数据库 (Redis)

- **作用**：用于缓存热点数据，减轻数据库压力，提升系统性能。
- **版本**：Redis 6.0。
- **缓存场景**：
    - **电影热点数据**：缓存热门电影列表、电影详情页等访问频繁的数据。
    - **用户会话**：存储用户的登录状态（Session Token）。
    - **配置信息**：缓存系统配置，避免频繁读取数据库。

## 5. 部署架构

- **容器化**：所有服务都将被容器化（使用`Docker`），以实现环境一致性和快速部署。
- **编排**：在开发和测试环境中，使用`Docker Compose`来编排和管理多个服务容器。
- **生产环境**：在生产环境中，可以迁移到`Kubernetes (K8s)`等更强大的容器编排平台，以实现服务的自动扩缩容、故障恢复和滚动更新。

---
